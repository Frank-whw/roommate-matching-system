# 室友匹配系统数据库表结构说明

## 概述

本系统使用 PostgreSQL 数据库，通过 Drizzle ORM 管理。数据库包含 7 个核心表和多个枚举类型，支持用户认证、个人资料、团队管理、匹配系统和活动日志等功能。

## 枚举类型

### 性别 (gender)
- `male` - 男性
- `female` - 女性  
- `other` - 其他

### MBTI 性格类型 (mbti)
包含全部 16 种 MBTI 类型：`INTJ`, `INTP`, `ENTJ`, `ENTP`, `INFJ`, `INFP`, `ENFJ`, `ENFP`, `ISTJ`, `ISFJ`, `ESTJ`, `ESFJ`, `ISTP`, `ISFP`, `ESTP`, `ESFP`

### 学习习惯 (study_habit)
- `library` - 常在图书馆
- `dormitory` - 常在寝室
- `flexible` - 灵活

### 生活方式 (lifestyle)
- `quiet` - 安静型
- `social` - 社交型
- `balanced` - 平衡型

### 清洁习惯 (cleanliness)
- `extremely_clean` - 极爱干净
- `regularly_tidy` - 定期收拾
- `acceptable` - 过得去就行

### 团队状态 (team_status)
- `recruiting` - 招募中
- `full` - 已满员
- `disbanded` - 已解散

### 匹配状态 (match_status)
- `pending` - 待处理
- `matched` - 已匹配/已通过
- `rejected` - 已拒绝

## 数据表结构

### 1. users - 用户基本信息表

存储用户的基础认证信息和账户状态。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| studentId | varchar(20) | NOT NULL, UNIQUE | 学号，格式：102*55014** (华师大格式) |
| email | varchar(255) | NOT NULL, UNIQUE | 教育邮箱 (@stu.ecnu.edu.cn) |
| passwordHash | text | NOT NULL | 密码哈希值 |
| name | varchar(100) | | 真实姓名 |
| isActive | boolean | NOT NULL, DEFAULT true | 账户激活状态 |
| isEmailVerified | boolean | NOT NULL, DEFAULT false | 邮箱验证状态 |
| emailVerificationToken | varchar(255) | | 邮箱验证令牌 |
| emailVerificationExpires | timestamp | | 令牌过期时间 |
| createdAt | timestamp | NOT NULL, DEFAULT NOW() | 创建时间 |
| updatedAt | timestamp | NOT NULL, DEFAULT NOW() | 更新时间 |
| deletedAt | timestamp | | 软删除时间 |

**索引：** `student_id_idx`, `email_idx`

### 2. userProfiles - 用户详细资料表

存储用户的详细个人信息、生活习惯和室友偏好。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| userId | integer | NOT NULL, UNIQUE, FK(users.id) | 关联用户ID |
| nickname | varchar(50) | | 昵称 (如：Frank) |
| wechatId | varchar(100) | | 微信号 |
| gender | gender | | 性别 |
| age | integer | | 年龄 |
| sleepTime | varchar(10) | | 睡觉时间 (格式：22:00) |
| wakeTime | varchar(10) | | 起床时间 (格式：07:00) |
| studyHabit | study_habit | | 学习习惯 |
| lifestyle | lifestyle | | 生活方式 |
| cleanliness | cleanliness | | 清洁习惯 |
| mbti | mbti | | MBTI性格类型 |
| roommateExpectations | text | | 室友期待描述 |
| hobbies | text | | 爱好兴趣 |
| dealBreakers | text | | 不能接受的行为 |
| bio | text | | 个人简介 |
| isProfileComplete | boolean | NOT NULL, DEFAULT false | 资料完整度状态 |
| createdAt | timestamp | NOT NULL, DEFAULT NOW() | 创建时间 |
| updatedAt | timestamp | NOT NULL, DEFAULT NOW() | 更新时间 |

**索引：** `profile_user_id_idx`

### 3. teams - 队伍表

存储团队的基本信息和状态。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| name | varchar(100) | NOT NULL | 队伍名称 |
| description | text | | 队伍描述 |
| leaderId | integer | NOT NULL, FK(users.id) | 队长ID |
| maxMembers | integer | NOT NULL, DEFAULT 4 | 最大成员数 |
| currentMembers | integer | NOT NULL, DEFAULT 1 | 当前成员数 |
| status | team_status | NOT NULL, DEFAULT 'recruiting' | 队伍状态 |
| requirements | text | | 招募要求 |
| createdAt | timestamp | NOT NULL, DEFAULT NOW() | 创建时间 |
| updatedAt | timestamp | NOT NULL, DEFAULT NOW() | 更新时间 |
| deletedAt | timestamp | | 软删除时间 |

**索引：** `team_leader_id_idx`, `team_status_idx`

### 4. teamMembers - 队伍成员表

管理团队成员关系和权限。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| teamId | integer | NOT NULL, FK(teams.id) CASCADE | 队伍ID |
| userId | integer | NOT NULL, FK(users.id) CASCADE | 用户ID |
| isLeader | boolean | NOT NULL, DEFAULT false | 是否为队长 |
| joinedAt | timestamp | NOT NULL, DEFAULT NOW() | 加入时间 |

**索引：** `team_member_team_id_idx`, `team_member_user_id_idx`, `unique_user_team_idx` (确保一个用户只能在一个队伍中)

### 5. teamJoinRequests - 入队申请表

处理用户加入团队的申请流程。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| teamId | integer | NOT NULL, FK(teams.id) CASCADE | 申请加入的队伍ID |
| userId | integer | NOT NULL, FK(users.id) CASCADE | 申请用户ID |
| message | text | | 申请留言 |
| status | match_status | NOT NULL, DEFAULT 'pending' | 申请状态 |
| reviewedBy | integer | FK(users.id) | 审核人（队长）ID |
| reviewedAt | timestamp | | 审核时间 |
| createdAt | timestamp | NOT NULL, DEFAULT NOW() | 创建时间 |
| updatedAt | timestamp | NOT NULL, DEFAULT NOW() | 更新时间 |

**索引：** `join_request_team_id_idx`, `join_request_user_id_idx`, `join_request_status_idx`

### 6. userLikes - 互喜表

记录用户之间的点赞/不喜欢关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| fromUserId | integer | NOT NULL, FK(users.id) CASCADE | 点赞发起者ID |
| toUserId | integer | NOT NULL, FK(users.id) CASCADE | 被点赞者ID |
| isLike | boolean | NOT NULL, DEFAULT true | true=喜欢，false=不喜欢 |
| createdAt | timestamp | NOT NULL, DEFAULT NOW() | 创建时间 |

**索引：** `like_from_user_id_idx`, `like_to_user_id_idx`, `unique_user_pair_like_idx` (确保每对用户只能有一个点赞记录)

### 7. matches - 匹配结果表

存储双向喜欢后形成的匹配关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| user1Id | integer | NOT NULL, FK(users.id) CASCADE | 用户1 ID |
| user2Id | integer | NOT NULL, FK(users.id) CASCADE | 用户2 ID |
| matchScore | integer | | 匹配度评分 (0-100) |
| status | match_status | NOT NULL, DEFAULT 'matched' | 匹配状态 |
| createdAt | timestamp | NOT NULL, DEFAULT NOW() | 创建时间 |
| updatedAt | timestamp | NOT NULL, DEFAULT NOW() | 更新时间 |

**索引：** `match_user1_id_idx`, `match_user2_id_idx`, `match_status_idx`

### 8. activityLogs - 活动日志表

记录系统中所有重要的用户活动和操作。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | serial | PRIMARY KEY | 自增主键 |
| userId | integer | NOT NULL, FK(users.id) CASCADE | 操作用户ID |
| action | text | NOT NULL | 操作类型/动作 |
| timestamp | timestamp | NOT NULL, DEFAULT NOW() | 操作时间 |
| ipAddress | varchar(45) | | 操作者IP地址 |
| metadata | text | | 附加数据 (JSON格式) |

**索引：** `activity_log_user_id_idx`, `activity_log_action_idx`

## 活动类型枚举 (ActivityType)

系统支持的活动日志类型包括：

### 用户相关
- `SIGN_UP` - 注册
- `SIGN_IN` - 登录  
- `SIGN_OUT` - 登出
- `EMAIL_VERIFIED` - 邮箱验证
- `UPDATE_PASSWORD` - 更新密码
- `DELETE_ACCOUNT` - 删除账户
- `UPDATE_ACCOUNT` - 更新账户
- `UPDATE_PROFILE` - 更新个人资料

### 匹配相关
- `LIKE_USER` - 点赞用户
- `PASS_USER` - 跳过用户
- `MATCH_SUCCESS` - 匹配成功
- `UNMATCH` - 取消匹配

### 队伍相关
- `CREATE_TEAM` - 创建队伍
- `JOIN_TEAM` - 加入队伍
- `LEAVE_TEAM` - 离开队伍
- `REQUEST_JOIN_TEAM` - 申请加入队伍
- `APPROVE_JOIN_REQUEST` - 通过入队申请
- `REJECT_JOIN_REQUEST` - 拒绝入队申请
- `BECOME_TEAM_LEADER` - 成为队长
- `DISBAND_TEAM` - 解散队伍
- `REMOVE_TEAM_MEMBER` - 移除队员

## 关键业务约束

1. **用户约束**
   - 学号格式固定：102*55014** (华师大格式)
   - 邮箱域名限制：@stu.ecnu.edu.cn
   - 一个用户最多只能加入一个队伍

2. **匹配机制**
   - 需要双向点赞才能形成匹配
   - 每对用户之间只能有一个点赞记录

3. **团队管理**
   - 默认最大队伍成员数为4人
   - 队长负责审核入队申请
   - 支持队伍解散和成员管理

4. **数据完整性**
   - 级联删除确保数据一致性
   - 软删除支持数据恢复
   - 完整的外键约束和索引优化